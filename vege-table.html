<link rel="import" href="../../bower_components/polymer/polymer.html">

<!--<script src="../es6-promise/es6-promise.js"></script>-->

<link rel="import" href="../marked-element/marked-element.html">
<link rel="import" href="../web-resource/web-resource.html">

<link rel="import" href="seed-harvester.html">
<link rel="import" href="leaf-builder.html">
<link rel="import" href="leaf-miner.html">
<link rel="import" href="vege-table-leaf.html">
<link rel="import" href="tuber-storage.html">

<polymer-element name="vege-table" attributes="db descriptionFile dataFile items leaves">
  <template>
    <link rel="stylesheet" href="vege-table.css">

    <tuber-storage id="storage" storage="{{ db }}"
      seed="{{ seed }}" leaves="{{ leaves }}" items="{{ items }}" progress="{{ progress }}"></tuber-storage>

    <!-- leaf-miner -->
    <leaf-miner id="miner"
      items="{{ items }}"
      leaves="{{ leaves }}"
      on-item-changed="{{ updateItem }}"
      on-leaf-complete="{{ leafComplete }}">
    </leaf-miner>

    <resource-queue></resource-queue>

    <!-- vege-table -->
    <section class="panel panel-default">
      <h2 class="panel-heading">Data</h2>

      <template if="{{ items.length }}">
        <div class="panel-body">
          <div>Page {{ page }} of  {{ pages }} {{ pages | pageMessage }}</div>

          <div><input value="{{ page }}" type="range" min="1" max="{{ pages }}"></div>

          <div>Show <select value="{{ indexLimit }}">
            <option>5</option>
            <option>10</option>
            <option>25</option>
            <option>100</option>
            <!-- TODO: generate up to max item length -->
          </select> items per page ({{ itemCount }} total)</div>
        </div>

        <table class="table">
          <caption><!-- TODO --></caption>

          <!-- TODO: allow columns to be resized - set width style here -->
          <colgroup>
            <template repeat="{{ leaves }}">
              <col span="1" width="0*">
            </template>
          </colgroup>

          <thead>
            <tr>
              <template repeat="{{ leaf in leaves }}">
              <th class="leaf-type-{{ leaf.type }}">{{ leaf.title }}</th>
              </template>
            </tr>

            <tr class="table-actions">
              <template repeat="{{ leaf in leaves }}">
              <th>
                <template if="{{ leaf.index > 0 }}">
                  <button type="button"
                    class="btn btn-xs btn-default"
                    on-click="{{ moveLeaf }}"
                    data-leaf-name="{{ leaf.name }}"
                    data-leaf-move="left">&larr;</button>
                </template>

                <!-- TODO: set 'sortable'? -->
                <template if="{{ leaf.type !== 'list' }}">
                  <button type="button"
                    class="btn btn-xs btn-default"
                    on-click="{{ sortLeaf }}"
                    data-leaf-name="{{ leaf.name }}"
                    data-leaf-sort="asc">A</button>

                  <button type="button"
                    class="btn btn-xs btn-default"
                    on-click="{{ sortLeaf }}"
                    data-leaf-name="{{ leaf.name }}"
                    data-leaf-sort="desc">Z</button>
                </template>

                <template if="{{ leaf.index < leaves.length - 1 }}">
                  <button type="button"
                    class="btn btn-xs btn-default"
                    on-click="{{ moveLeaf }}"
                    data-leaf-name="{{ leaf.name }}"
                    data-leaf-move="right">&rarr;</button>
                </template>
              </th>
              </template>
            </tr>
          </thead>

          <tbody>
            <template repeat="{{ item, index in displayItems }}">
              <template if="{{ index >= startIndex &amp;&amp; index <= endIndex }}">
                <tr>
                  <template repeat="{{ leaf in leaves }}">
                    <td is="vege-table-leaf"
                      class="leaf-type-{{ leaf.type }}"
                      value="{{ item[leaf.name] }}"
                      type="{{ leaf.type }}"></td>
                  </template>
                </tr>
              </template>
            </template>
          </tbody>

          <tfoot class="summaries">
            <tr class="table-actions">
              <template repeat="{{ leaf in leaves }}">
                <td>
                  <span class="badge {{ { 'alert-success': leaf.complete == items.length } | tokenList }}">{{ leaf.complete }}</span>

                  <template if="{{ db }}">
                    <button type="button"
                      class="btn btn-xs btn-default"
                      on-click="{{ fetchLeaf }}"
                      data-leaf-name="{{ leaf.name }}">Fetch</button>
                  </template>

                  <template if="{{ leaf.index != 0 }}">
                    <button type="button"
                      class="btn btn-xs btn-default"
                      on-click="{{ summariseLeaf }}"
                      data-leaf-name="{{ leaf.name }}">Sum</button>
                  </template>

                  <!--
                  <template if="{{ db }}">
                    <button class="btn btn-xs btn-danger" on-click="{{ clearLeaf }}" data-leaf-name="{{ leaf.name }}">Clear</button>
                  </template>
                  -->
                </td>
              </template>
            </tr>

            <template repeat="{{ summariser in summarisers }}">
              <tr>
                <th>{{ summariser.label }}</th>

                <template repeat="{{ summary, summaryIndex in summariser.summaries }}">
                  <td>
                    <template if="{{ summary }}">
                      <template if="{{ summariser.type != 'list' }}">
                        <div>{{ summary }}</div>
                      </template>

                      <template if="{{ summariser.type == 'list' }}">
                        <div class="list-group">
                          <template repeat="{{ s in summary }}">
                            <!-- TODO: active filter for list types -->
                            <a href="#"
                              class="leaf-count list-group-item {{ { active: filter.key == summary.leafName &amp;&amp; filter.value == s.key } | tokenList }}"
                              data-leaf-index="{{ summaryIndex + 1 }}"
                              data-filter-value="{{ s.key }}"
                              on-click="{{ filterTable }}"><span class="badge">{{ s.count }}</span>{{ s.key }}</a>
                          </template>
                        </div>
                      </template>
                    </template>
                  </td>
                </template>
              </tr>
            </template>
          </tfoot>
        </table>
      </template>
    </section>

    <!-- leaf-builder -->
    <template if="{{ leaves.length || items.length }}">
      <section class="panel panel-default">
        <h2 class="panel-heading">Leaves</h2>

          <leaf-builder
            items="{{ items }}"
            leaves="{{ leaves }}"
            fields="{{ fields }}"
            db="{{ db }}"
            progress="{{ progress.leaves }}"
            on-leaf-added="{{ addLeaf }}"
            on-leaf-changed="{{ updateLeaf }}"
            on-leaf-removed="{{ removeLeaf }}"></leaf-builder>
      </section>
    </template>

    <!-- item builder -->
    <section class="panel panel-default">
      <h2 class="panel-heading">Preparation</h2>

      <!-- item builder -->
      <div class="panel-body">
        <seed-harvester id="harvester"
          seed="{{ seed }}"
          db="{{ db }}"
          progress="{{ progress.seed }}"
          on-seed-changed="{{ saveSeed }}"
          on-add-items="{{ addItems }}"
          on-clear-add-items="{{ clearAddItems }}"></seed-harvester>
      </div>
    </section>

    <template if="{{ db }}">
      <section class="panel panel-default">
        <h2 class="panel-heading">Import / Export</h2>

        <form class="panel-body">
          <div class="row">
           <fieldset class="col-md-6">
             <legend>Import</legend>

             <h3>Description</h3>
             <div><input type="file" on-change="{{ importDescriptionFile }}"></div>

             <h3>Data</h3>
             <div><input type="file" on-change="{{ importDataFile }}"></div>
           </fieldset>

           <fieldset class="col-md-6">
             <template if="{{ seed.data }}">
               <legend>Export</legend>

               <div class="form-actions">
                 <button type="button"
                   class="btn btn-default"
                   on-click="{{ export }}">Export files</button>
               </div>
             </template>
           </fieldset>
          </div>
         </form>
      </section>
    </template>
  </template>

  <script src="vege-table.js"></script>
</polymer-element>
